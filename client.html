<html>
    <body>

        <p>
            Users: <span id="users"></span>
        </p>

        <form id="message-form">
            <span id="nick"></span>: <input id="message-input" type="text" size="60" />
            <input type="submit" value="Send" />
        </form>

        <div id="messages"></div>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>

            $(document).ready(function() {

                // Create a connection to the server
                var socket = io.connect("http://192.168.1.67:1337");
                
                
                /*
                    Join the chat-room
                    ------------------
                */
                (function join() {

                    // Grab a nickname from the user and send it to the server
                    var nick = prompt("Enter a nickname:");
                    if (nick) {

                        socket.emit("join", nick, function(successful) {

                            // If the nickname was accepted, set-up the chat client
                            if (successful) {

                                // Display the nickname on the page
                                $("#nick").text(nick);


                                /*
                                    Send chat messages
                                    ------------------
                                */
                                $("#message-form").submit(function(ev) {
                                    // Prevent the browser from submitting the form via HTTP
                                    ev.preventDefault();
                                    // Send the message to the server
                                    socket.emit("chat", $("#message-input").val());
                                    // Clear the text-box
                                    $("#message-input").val("");
                                });


                                /*
                                    Handle chat messages
                                    --------------------
                                */
                                socket.on("chat", function(message) {
                                    // Inject the message into the DOM
                                    $("#messages").prepend("<div><b>" + message.sender + "</b>: " + message.message + "</div>");
                                });


                                /*
                                    Handle system messages
                                    ----------------------
                                */
                                socket.on("system-message", function(message) {
                                    // Inject the message into the DOM
                                    $("#messages").prepend("<div><i>" + message + "</i></div>");
                                });


                                /*
                                    Handle a list of connected users
                                    --------------------------------
                                */
                                socket.on("all-users", function(users) {
                                    // Inject the list into the DOM
                                    $.each(users, function(i, user) {
                                        $("#users").append('<span id="user-' + user + '">' + user + ' </span>');
                                    });
                                })


                                /*
                                    Handle users joining
                                    --------------------
                                */
                                socket.on("user-joined", function(user) {
                                    // Add to the on-page list of users
                                    $("#users").append('<span id="user-' + user + '">' + user + ' </span>');
                                    // Display a message in the main chat stream
                                    $("#messages").prepend("<div><i>" + user + " joined</i></div>");
                                });


                                /*
                                    Handle users leaving
                                    --------------------
                                */
                                socket.on("user-left", function(user) {
                                    // Remove from the on-age list of users
                                    $("#user-" + user).remove();
                                    // Display a message in the main chat stream
                                    $("#messages").prepend("<div><i>" + user + " left</i></div>");
                                });


                                /*
                                    Handle server disconnection
                                    ---------------------------
                                */
                                socket.on("disconnect", function() {
                                    alert("The server went away")
                                });


                            // If the nickname wasn't accepted, ask for another and try again
                            } else {
                                alert("Nickname already in use");
                                join();
                            }
                        });
                    
                    // If a nickname wasn't provided, ask again
                    } else {
                        join();
                    }
                    
                })();
                
            });
        </script>
    </body>
</html>