<html>
    <head>
        <link rel="stylesheet" href="http://yui.yahooapis.com/3.3.0/build/cssreset/reset-min.css" />
        <style type="text/css">
            body { font-family: sans-serif; }
            #main { width: 80%; height: 100%; float: left; }
            #messages { height: 90%; border-bottom: 1px solid #999; margin-top: 0px; overflow-y: scroll; }
            #message-form { height: 10%; }
            #message-input { width: 100%; height: 100%; padding: 0 10px; border: none; outline: none; }
            #users { width: 20%; height: 100%; float: left; background-color: #ddd; }
            .sender { font-weight: bold; }
            .system-message { font-style: italic; }
        </style>
    </head>

    <body>

        <div id="main">
            <ul id="messages">
            </ul>
            <form id="message-form">
                <input id="message-input" />
            </form>
        </div>
        <ul id="users">
        </ul>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>

            $(document).ready(function() {

                // Create a connection to the server
                var socket = io.connect("http://192.168.1.67:1337");
                
                
                /*
                    Join the chat-room
                    ------------------
                */
                (function join() {

                    // Grab a nickname from the user and send it to the server
                    var nick = prompt("Enter a nickname:");
                    if (nick) {

                        socket.emit("join", nick, function(successful, users) {

                            // If the nickname was accepted, set-up the chat client
                            if (successful) {

                                // Display a welcome message
                                $("#messages").append('<li class="system-message">Welcome, ' + nick + '</li>');

                                // Display the list of connected users on the page
                                $.each(users, function(i, user) {
                                    $("#users").append('<li id="user-' + user + '">' + user + ' </li>');
                                });

                                // Give focus to the message input so the user can start entering a message
                                $("#message-input").focus();


                                /*
                                    Send chat messages
                                    ------------------
                                */
                                $("#message-form").submit(function(ev) {
                                    // Prevent the browser from submitting the form via HTTP
                                    ev.preventDefault();
                                    // Send the message to the server
                                    socket.emit("chat", $("#message-input").val());
                                    // Clear the text-box
                                    $("#message-input").val("");
                                });


                                /*
                                    Handle chat messages
                                    --------------------
                                */
                                socket.on("chat", function(message) {
                                    // Inject the message into the DOM
                                    $("#messages").append('<li><span class="sender">' + message.sender + '</span>: ' + message.message + '</li>');
                                    // Auto-scroll the message pane
                                    $("#messages").scrollTop($("#messages").prop("scrollHeight") - $("#messages").height());
                                });


                                /*
                                    Handle system messages
                                    ----------------------
                                */
                                socket.on("system-message", function(message) {
                                    // Inject the message into the DOM
                                    $("#messages").append('<li class="system-message">' + message + '</li>');
                                    // Auto-scroll the message pane
                                    $("#messages").prop("scrollTop", $("#messages").attr("scrollHeight") - $("#messages").height());
                                });


                                /*
                                    Handle users joining
                                    --------------------
                                */
                                socket.on("user-joined", function(user) {
                                    // Add to the on-page list of users
                                    $("#users").append('<li id="user-' + user + '">' + user + ' </li>');
                                    // Display a message in the main chat stream
                                    $("#messages").append('<li class="system-message">' + user + ' joined</li>');
                                });


                                /*
                                    Handle users leaving
                                    --------------------
                                */
                                socket.on("user-left", function(user) {
                                    // Remove from the on-page list of users
                                    $("#user-" + user).remove();
                                    // Display a message in the main chat stream
                                    $("#messages").append('<li class="message system-message">' + user + ' left</li>');
                                });


                                /*
                                    Handle server disconnection
                                    ---------------------------
                                */
                                socket.on("disconnect", function() {
                                    alert("The server went away")
                                });


                            // If the nickname wasn't accepted, ask for another and try again
                            } else {
                                alert("Nickname already in use");
                                join();
                            }
                        });
                    
                    // If a nickname wasn't provided, ask again
                    } else {
                        join();
                    }
                    
                })();
                
            });
        </script>
    </body>
</html>